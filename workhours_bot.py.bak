import gspread
from google.oauth2.service_account 
import Credentials
import os
import logging
from datetime import datetime, timedelta
from apscheduler.schedulers.background import BackgroundScheduler
from pytz import timezone
from dotenv import load_dotenv
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters, ConversationHandler

# -------------------- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è --------------------
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
BOSS_ID = int(os.getenv("BOSS_ID"))  # Telegram ID –±–æ—Å–∞

logging.basicConfig(level=logging.INFO)

# –ï—Ç–∞–ø–∏ –¥—ñ–∞–ª–æ–≥—É
START_TIME, END_TIME, LUNCH = range(3)

# –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
user_data = {}

# -------------------- –ö–æ–º–∞–Ω–¥–∏ --------------------

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤—ñ—Ç üëã –í–≤–µ–¥–∏ —á–∞—Å, –∫–æ–ª–∏ –ø–æ—á–∞–≤ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 09:00):"
    )
    return START_TIME


async def get_start_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data[update.effective_user.id] = {"start": update.message.text}
    await update.message.reply_text("–î–æ–±—Ä–µ ‚úÖ –¢–µ–ø–µ—Ä –≤–≤–µ–¥–∏ —á–∞—Å, –∫–æ–ª–∏ –∑–∞–∫—ñ–Ω—á–∏–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 17:30):")
    return END_TIME


async def get_end_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data[update.effective_user.id]["end"] = update.message.text

    reply_keyboard = [["–¢–∞–∫", "–ù—ñ"]]
    await update.message.reply_text(
        "–í—ñ–¥–Ω—ñ–º–∞—Ç–∏ 30 —Ö–≤ –Ω–∞ –æ–±—ñ–¥? üçΩÔ∏è",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True)
    )
    return LUNCH


async def get_lunch(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    lunch = update.message.text.lower() == "—Ç–∞–∫"
    start_time = user_data[user_id]["start"]
    end_time = user_data[user_id]["end"]

    fmt = "%H:%M"
    start_dt = datetime.strptime(start_time, fmt)
    end_dt = datetime.strptime(end_time, fmt)

    total_hours = (end_dt - start_dt).seconds / 3600
    if lunch:
        total_hours -= 0.5

    date_today = datetime.now().strftime("%d.%m.%Y")

    text = (
        f"üìÖ –î–∞—Ç–∞: {date_today}\n"
        f"üïò –ü–æ—á–∞—Ç–æ–∫: {start_time}\n"
        f"üïî –ö—ñ–Ω–µ—Ü—å: {end_time}\n"
        f"üçΩÔ∏è –û–±—ñ–¥: {'–¢–∞–∫' if lunch else '–ù—ñ'}\n"
        f"‚è±Ô∏è –í—Å—å–æ–≥–æ –≥–æ–¥–∏–Ω: {total_hours:.1f}"
    )

    # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –±–æ—Å—É
    await context.bot.send_message(chat_id=BOSS_ID, text=f"üì® –ó–≤—ñ—Ç –≤—ñ–¥ {update.effective_user.first_name}:\n\n{text}")

    # –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    await update.message.reply_text("‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Å—É!")

    # –†–µ–∫–ª–∞–º–∞ —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º, –Ω–µ –±–æ—Å—É
    if user_id != BOSS_ID:
        await update.message.reply_text("üî• –†–µ–∫–ª–∞–º–∞: –ü–µ—Ä–µ–≤—ñ—Ä –Ω–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è —Ç—Ä–µ–∫—ñ–Ω–≥—É —á–∞—Å—É –Ω–∞ –Ω–∞—à–æ–º—É —Å–∞–π—Ç—ñ!")

    return ConversationHandler.END


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("‚ùå –í—ñ–¥–º—ñ–Ω–µ–Ω–æ.")
    return ConversationHandler.END

# -------------------- –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è --------------------

def send_reminder(app):
    tz = timezone("Europe/Kyiv")
    now = datetime.now(tz)
    message = "‚è∞ –ù–µ –∑–∞–±—É–¥—å –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–æ —Ä–æ–±–æ—á–∏–π –¥–µ–Ω—å!"
    for user_id in user_data.keys():
        app.bot.send_message(chat_id=user_id, text=message)

# -------------------- –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è --------------------

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            START_TIME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_start_time)],
            END_TIME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_end_time)],
            LUNCH: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_lunch)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    app.add_handler(conv_handler)

    # –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –¥–ª—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å –æ 21:00
    scheduler = BackgroundScheduler(timezone="Europe/Kyiv")
    scheduler.add_job(lambda: send_reminder(app), "cron", hour=21, minute=0)
    scheduler.start()

    app.run_polling()


if __name__ == "__main__":
    main()
